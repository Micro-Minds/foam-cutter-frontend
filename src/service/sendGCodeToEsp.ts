/*
export async function sendGcodeToESP(gcode: string[]): Promise<void> {
    const espUrl = "ws://192.168.8.103:81";

    const gcode1="G21\n" +
        "G90\n" +
        "G1 Z-1 F100\n" +
        "G1 X0 Y0 F200\n" +
        "G1 X20 Y0\n" +
        "G1 X40 Y0\n" +
        "G1 X40 Y15\n" +
        "G1 X40 Y30\n" +
        "G1 X20 Y30\n" +
        "G1 X0 Y30\n" +
        "G1 X0 Y15\n" +
        "G1 X0 Y0\n" +
        "G1 Z5 F100\n" +
        "M30\n";
    return new Promise<void>((resolve, reject) => {
        const socket = new WebSocket(espUrl);

        socket.onopen = async () => {
            console.log("‚úÖ WebSocket connected to ESP32");

            try {
                for (let i = 0; i < gcode1.length; i++) {
                    const line = gcode1[i].trim();
                    if (line) {
                        console.log(üîÑ Sending line ${i + 1}: ${line});
                        socket.send(line);
                        await new Promise(res => setTimeout(res, 200)); // 200ms delay
                    }
                }
                socket.close();
            } catch (err) {
                console.error("üö® Error while sending G-code:", err);
                socket.close(); // Close on failure
                reject(err);
            }
        };

        socket.onclose = () => {
            console.log("üõë WebSocket closed");
            resolve();
        };

        socket.onerror = (err) => {
            console.error("‚ùå WebSocket error:", err);
            reject(err);
        };
    });
}
*/

export async function sendGcodeToESP(gcode: string): Promise<void> {
    const espUrl = "ws://192.168.8.103:81";

    /*const gcode1 = "(Header)\n" +
        "(Generated by gcodetools from Inkscape.)\n" +
        "(Using default header. To add your own header create file \"header\" in the output dir.)\n" +
        "M3\n" +
        "(Header end.)\n" +
        "G21 (All units in mm)\n" +
        "\n" +
        "(Start cutting path id: rect42336)\n" +
        "(Change tool to Cylindrical cutter)\n" +
        "\n" +
        "G00 Z0.000000\n" +
        "G00 X0.121440 Y15.438417\n" +
        "\n" +
        "G01 Z-2.000000 F100.0(Penetrate)\n" +
        "G01 X62.525383 Y15.438417 Z-2.000000 F200.000000\n" +
        "G01 X62.586877 Y34.665661 Z-2.000000\n" +
        "G02 X63.895873 Y55.970333 Z-2.000000 I183.710579 J-0.594948\n" +
        "G02 X65.678679 Y60.385039 Z-2.000000 I9.047203 J-1.086231\n" +
        "G03 X68.189295 Y64.148414 Z-2.000000 I-2.488544 J4.379279\n" +
        "G03 X66.668797 Y68.180934 Z-2.000000 I-4.603440 J0.567151\n" +
        "G02 X66.183268 Y82.599884 Z-2.000000 I14.391494 J7.702255\n" +
        "G02 X78.665482 Y94.730734 Z-2.000000 I21.623655 J-9.762671\n" +
        "G03 X84.758121 Y98.400333 Z-2.000000 I-9.422881 J22.537421\n" +
        "G03 X85.795278 Y100.596017 Z-2.000000 I-1.805566 J2.195679\n" +
        "G02 X86.460863 Y103.169279 Z-2.000000 I5.307117 J-0.000000\n" +
        "G02 X88.761505 Y105.944516 Z-2.000000 I8.526248 J-4.726947\n" +
        "G03 X93.672563 Y115.173324 Z-2.000000 I-8.800655 J10.604318\n" +
        "G03 X89.683414 Y124.468974 Z-2.000000 I-10.395122 J1.042802\n" +
        "G02 X86.004382 Y130.573281 Z-2.000000 I6.068800 J7.818453\n" +
        "G02 X87.698521 Y134.299382 Z-2.000000 I3.565624 J0.627011\n" +
        "G03 X89.565338 Y136.608859 Z-2.000000 I-4.224930 J5.324374\n" +
        "G03 X89.643624 Y138.713585 Z-2.000000 I-2.302322 J1.139454\n" +
        "G02 X75.448508 Y149.884912 Z-2.000000 I58.023440 J88.333225\n" +
        "G02 X67.761104 Y159.530693 Z-2.000000 I29.049042 J31.037442\n" +
        "G02 X63.337720 Y170.941692 Z-2.000000 I33.714630 J19.632055\n" +
        "G02 X61.598307 Y186.876530 Z-2.000000 I75.772043 J16.333472\n" +
        "G02 X61.962483 Y197.171263 Z-2.000000 I128.603640 J0.604451\n" +
        "G02 X63.457317 Y204.765344 Z-2.000000 I32.521667 J-2.457466\n" +
        "G02 X66.525382 Y212.422285 Z-2.000000 I57.907959 J-18.760038\n" +
        "G02 X76.244957 Y232.045349 Z-2.000000 I898.244036 J-432.694030\n" +
        "G03 X86.257462 Y248.898464 Z-2.000000 I-193.907667 J126.602136\n" +
        "G03 X90.974808 Y260.994485 Z-2.000000 I-47.015288 J25.303440\n" +
        "G03 X92.427959 Y272.279131 Z-2.000000 I-45.332559 J11.573465\n" +
        "G03 X91.806799 Y289.447012 Z-2.000000 I-202.932980 J1.252755\n" +
        "G03 X91.060853 Y317.317829 Z-2.000000 I-249.210251 J7.275429\n" +
        "G03 X89.126342 Y321.779921 Z-2.000000 I-7.558453 J-0.626526\n" +
        "G02 X86.348927 Y326.282036 Z-2.000000 I10.788872 J9.763567\n" +
        "G02 X84.489509 Y332.932993 Z-2.000000 I33.118014 J12.844254\n" +
        "G02 X84.168153 Y339.630282 Z-2.000000 I26.001621 J4.603990\n" +
        "G02 X85.561701 Y341.912026 Z-2.000000 I2.948751 J-0.234495\n" +
        "G03 X87.300914 Y345.341809 Z-2.000000 I-1.939015 J3.139119\n" +
        "G03 X85.131753 Y347.346319 Z-2.000000 I-2.169161 J-0.171413\n" +
        "G02 X81.412433 Y348.646564 Z-2.000000 I-0.000000 J5.969637\n" +
        "G02 X75.997985 Y354.235275 Z-2.000000 I18.899907 J23.727749\n" +
        "G02 X71.913401 Y361.021638 Z-2.000000 I32.068674 J23.923927\n" +
        "G02 X69.768867 Y367.939377 Z-2.000000 I23.114668 J10.956941\n" +
        "G03 X67.499375 Y376.412867 Z-2.000000 I-42.069518 J-6.726995\n" +
        "G03 X65.427531 Y379.306126 Z-2.000000 I-6.548859 J-2.501150\n" +
        "G02 X63.724760 Y382.286848 Z-2.000000 I3.121287 J3.759794\n" +
        "G02 X62.517630 Y397.332931 Z-2.000000 I93.166212 J15.046083\n" +
        "G01 X62.517630 Y412.056062 Z-2.000000\n" +
        "G01 X0.121440 Y412.056062 Z-2.000000\n" +
        "G01 X0.121440 Y15.438417 Z-2.000000\n" +
        "G00 Z-2.000000\n" +
        "\n" +
        "(End cutting path id: rect42336)\n" +
        "\n" +
        "\n" +
        "(Start cutting path id: rect42336)\n" +
        "(Change tool to Cylindrical cutter)\n" +
        "\n" +
        "G00 Z-2.000000\n" +
        "G00 X0.121440 Y15.438417\n" +
        "\n" +
        "G01 Z-4.000000 F100.0(Penetrate)\n" +
        "G01 X62.525383 Y15.438417 Z-4.000000 F200.000000\n" +
        "G01 X62.586877 Y34.665661 Z-4.000000\n" +
        "G02 X63.895873 Y55.970333 Z-4.000000 I183.710579 J-0.594948\n" +
        "G02 X65.678679 Y60.385039 Z-4.000000 I9.047203 J-1.086231\n" +
        "G03 X68.189295 Y64.148414 Z-4.000000 I-2.488544 J4.379279\n" +
        "G03 X66.668797 Y68.180934 Z-4.000000 I-4.603440 J0.567151\n" +
        "G02 X66.183268 Y82.599884 Z-4.000000 I14.391494 J7.702255\n" +
        "G02 X78.665482 Y94.730734 Z-4.000000 I21.623655 J-9.762671\n" +
        "G03 X84.758121 Y98.400333 Z-4.000000 I-9.422881 J22.537421\n" +
        "G03 X85.795278 Y100.596017 Z-4.000000 I-1.805566 J2.195679\n" +
        "G02 X86.460863 Y103.169279 Z-4.000000 I5.307117 J-0.000000\n" +
        "G02 X88.761505 Y105.944516 Z-4.000000 I8.526248 J-4.726947\n" +
        "G03 X93.672563 Y115.173324 Z-4.000000 I-8.800655 J10.604318\n" +
        "G03 X89.683414 Y124.468974 Z-4.000000 I-10.395122 J1.042802\n" +
        "G02 X86.004382 Y130.573281 Z-4.000000 I6.068800 J7.818453\n" +
        "G02 X87.698521 Y134.299382 Z-4.000000 I3.565624 J0.627011\n" +
        "G03 X89.565338 Y136.608859 Z-4.000000 I-4.224930 J5.324374\n" +
        "G03 X89.643624 Y138.713585 Z-4.000000 I-2.302322 J1.139454\n" +
        "G02 X75.448508 Y149.884912 Z-4.000000 I58.023440 J88.333225\n" +
        "G02 X67.761104 Y159.530693 Z-4.000000 I29.049042 J31.037442\n" +
        "G02 X63.337720 Y170.941692 Z-4.000000 I33.714630 J19.632055\n" +
        "G02 X61.598307 Y186.876530 Z-4.000000 I75.772043 J16.333472\n" +
        "G02 X61.962483 Y197.171263 Z-4.000000 I128.603640 J0.604451\n" +
        "G02 X63.457317 Y204.765344 Z-4.000000 I32.521667 J-2.457466\n" +
        "G02 X66.525382 Y212.422285 Z-4.000000 I57.907959 J-18.760038\n" +
        "G02 X76.244957 Y232.045349 Z-4.000000 I898.244036 J-432.694030\n" +
        "G03 X86.257462 Y248.898464 Z-4.000000 I-193.907667 J126.602136\n" +
        "G03 X90.974808 Y260.994485 Z-4.000000 I-47.015288 J25.303440\n" +
        "G03 X92.427959 Y272.279131 Z-4.000000 I-45.332559 J11.573465\n" +
        "G03 X91.806799 Y289.447012 Z-4.000000 I-202.932980 J1.252755\n" +
        "G03 X91.060853 Y317.317829 Z-4.000000 I-249.210251 J7.275429\n" +
        "G03 X89.126342 Y321.779921 Z-4.000000 I-7.558453 J-0.626526\n" +
        "G02 X86.348927 Y326.282036 Z-4.000000 I10.788872 J9.763567\n" +
        "G02 X84.489509 Y332.932993 Z-4.000000 I33.118014 J12.844254\n" +
        "G02 X84.168153 Y339.630282 Z-4.000000 I26.001621 J4.603990\n" +
        "G02 X85.561701 Y341.912026 Z-4.000000 I2.948751 J-0.234495\n" +
        "G03 X87.300914 Y345.341809 Z-4.000000 I-1.939015 J3.139119\n" +
        "G03 X85.131753 Y347.346319 Z-4.000000 I-2.169161 J-0.171413\n" +
        "G02 X81.412433 Y348.646564 Z-4.000000 I-0.000000 J5.969637\n" +
        "G02 X75.997985 Y354.235275 Z-4.000000 I18.899907 J23.727749\n" +
        "G02 X71.913401 Y361.021638 Z-4.000000 I32.068674 J23.923927\n" +
        "G02 X69.768867 Y367.939377 Z-4.000000 I23.114668 J10.956941\n" +
        "G03 X67.499375 Y376.412867 Z-4.000000 I-42.069518 J-6.726995\n" +
        "G03 X65.427531 Y379.306126 Z-4.000000 I-6.548859 J-2.501150\n" +
        "G02 X63.724760 Y382.286848 Z-4.000000 I3.121287 J3.759794\n" +
        "G02 X62.517630 Y397.332931 Z-4.000000 I93.166212 J15.046083\n" +
        "G01 X62.517630 Y412.056062 Z-4.000000\n" +
        "G01 X0.121440 Y412.056062 Z-4.000000\n" +
        "G01 X0.121440 Y15.438417 Z-4.000000\n" +
        "G00 Z-4.000000\n" +
        "\n" +
        "(End cutting path id: rect42336)\n" +
        "\n" +
        "\n" +
        "(Start cutting path id: rect42336)\n" +
        "(Change tool to Cylindrical cutter)\n" +
        "\n" +
        "G00 Z-4.000000\n" +
        "G00 X0.121440 Y15.438417\n" +
        "\n" +
        "G01 Z-6.000000 F100.0(Penetrate)\n" +
        "G01 X62.525383 Y15.438417 Z-6.000000 F200.000000\n" +
        "G01 X62.586877 Y34.665661 Z-6.000000\n" +
        "G02 X63.895873 Y55.970333 Z-6.000000 I183.710579 J-0.594948\n" +
        "G02 X65.678679 Y60.385039 Z-6.000000 I9.047203 J-1.086231\n" +
        "G03 X68.189295 Y64.148414 Z-6.000000 I-2.488544 J4.379279\n" +
        "G03 X66.668797 Y68.180934 Z-6.000000 I-4.603440 J0.567151\n" +
        "G02 X66.183268 Y82.599884 Z-6.000000 I14.391494 J7.702255\n" +
        "G02 X78.665482 Y94.730734 Z-6.000000 I21.623655 J-9.762671\n" +
        "G03 X84.758121 Y98.400333 Z-6.000000 I-9.422881 J22.537421\n" +
        "G03 X85.795278 Y100.596017 Z-6.000000 I-1.805566 J2.195679\n" +
        "G02 X86.460863 Y103.169279 Z-6.000000 I5.307117 J-0.000000\n" +
        "G02 X88.761505 Y105.944516 Z-6.000000 I8.526248 J-4.726947\n" +
        "G03 X93.672563 Y115.173324 Z-6.000000 I-8.800655 J10.604318\n" +
        "G03 X89.683414 Y124.468974 Z-6.000000 I-10.395122 J1.042802\n" +
        "G02 X86.004382 Y130.573281 Z-6.000000 I6.068800 J7.818453\n" +
        "G02 X87.698521 Y134.299382 Z-6.000000 I3.565624 J0.627011\n" +
        "G03 X89.565338 Y136.608859 Z-6.000000 I-4.224930 J5.324374\n" +
        "G03 X89.643624 Y138.713585 Z-6.000000 I-2.302322 J1.139454\n" +
        "G02 X75.448508 Y149.884912 Z-6.000000 I58.023440 J88.333225\n" +
        "G02 X67.761104 Y159.530693 Z-6.000000 I29.049042 J31.037442\n" +
        "G02 X63.337720 Y170.941692 Z-6.000000 I33.714630 J19.632055\n" +
        "G02 X61.598307 Y186.876530 Z-6.000000 I75.772043 J16.333472\n" +
        "G02 X61.962483 Y197.171263 Z-6.000000 I128.603640 J0.604451\n" +
        "G02 X63.457317 Y204.765344 Z-6.000000 I32.521667 J-2.457466\n" +
        "G02 X66.525382 Y212.422285 Z-6.000000 I57.907959 J-18.760038\n" +
        "G02 X76.244957 Y232.045349 Z-6.000000 I898.244036 J-432.694030\n" +
        "G03 X86.257462 Y248.898464 Z-6.000000 I-193.907667 J126.602136\n" +
        "G03 X90.974808 Y260.994485 Z-6.000000 I-47.015288 J25.303440\n" +
        "G03 X92.427959 Y272.279131 Z-6.000000 I-45.332559 J11.573465\n" +
        "G03 X91.806799 Y289.447012 Z-6.000000 I-202.932980 J1.252755\n" +
        "G03 X91.060853 Y317.317829 Z-6.000000 I-249.210251 J7.275429\n" +
        "G03 X89.126342 Y321.779921 Z-6.000000 I-7.558453 J-0.626526\n" +
        "G02 X86.348927 Y326.282036 Z-6.000000 I10.788872 J9.763567\n" +
        "G02 X84.489509 Y332.932993 Z-6.000000 I33.118014 J12.844254\n" +
        "G02 X84.168153 Y339.630282 Z-6.000000 I26.001621 J4.603990\n" +
        "G02 X85.561701 Y341.912026 Z-6.000000 I2.948751 J-0.234495\n" +
        "G03 X87.300914 Y345.341809 Z-6.000000 I-1.939015 J3.139119\n" +
        "G03 X85.131753 Y347.346319 Z-6.000000 I-2.169161 J-0.171413\n" +
        "G02 X81.412433 Y348.646564 Z-6.000000 I-0.000000 J5.969637\n" +
        "G02 X75.997985 Y354.235275 Z-6.000000 I18.899907 J23.727749\n" +
        "G02 X71.913401 Y361.021638 Z-6.000000 I32.068674 J23.923927\n" +
        "G02 X69.768867 Y367.939377 Z-6.000000 I23.114668 J10.956941\n" +
        "G03 X67.499375 Y376.412867 Z-6.000000 I-42.069518 J-6.726995\n" +
        "G03 X65.427531 Y379.306126 Z-6.000000 I-6.548859 J-2.501150\n" +
        "G02 X63.724760 Y382.286848 Z-6.000000 I3.121287 J3.759794\n" +
        "G02 X62.517630 Y397.332931 Z-6.000000 I93.166212 J15.046083\n" +
        "G01 X62.517630 Y412.056062 Z-6.000000\n" +
        "G01 X0.121440 Y412.056062 Z-6.000000\n" +
        "G01 X0.121440 Y15.438417 Z-6.000000\n" +
        "G00 Z-6.000000\n" +
        "\n" +
        "(End cutting path id: rect42336)\n" +
        "\n" +
        "\n" +
        "(Start cutting path id: rect42336)\n" +
        "(Change tool to Cylindrical cutter)\n" +
        "\n" +
        "G00 Z-6.000000\n" +
        "G00 X0.121440 Y15.438417\n" +
        "\n" +
        "G01 Z-8.000000 F100.0(Penetrate)\n" +
        "G01 X62.525383 Y15.438417 Z-8.000000 F200.000000\n" +
        "G01 X62.586877 Y34.665661 Z-8.000000\n" +
        "G02 X63.895873 Y55.970333 Z-8.000000 I183.710579 J-0.594948\n" +
        "G02 X65.678679 Y60.385039 Z-8.000000 I9.047203 J-1.086231\n" +
        "G03 X68.189295 Y64.148414 Z-8.000000 I-2.488544 J4.379279\n" +
        "G03 X66.668797 Y68.180934 Z-8.000000 I-4.603440 J0.567151\n" +
        "G02 X66.183268 Y82.599884 Z-8.000000 I14.391494 J7.702255\n" +
        "G02 X78.665482 Y94.730734 Z-8.000000 I21.623655 J-9.762671\n" +
        "G03 X84.758121 Y98.400333 Z-8.000000 I-9.422881 J22.537421\n" +
        "G03 X85.795278 Y100.596017 Z-8.000000 I-1.805566 J2.195679\n" +
        "G02 X86.460863 Y103.169279 Z-8.000000 I5.307117 J-0.000000\n" +
        "G02 X88.761505 Y105.944516 Z-8.000000 I8.526248 J-4.726947\n" +
        "G03 X93.672563 Y115.173324 Z-8.000000 I-8.800655 J10.604318\n" +
        "G03 X89.683414 Y124.468974 Z-8.000000 I-10.395122 J1.042802\n" +
        "G02 X86.004382 Y130.573281 Z-8.000000 I6.068800 J7.818453\n" +
        "G02 X87.698521 Y134.299382 Z-8.000000 I3.565624 J0.627011\n" +
        "G03 X89.565338 Y136.608859 Z-8.000000 I-4.224930 J5.324374\n" +
        "G03 X89.643624 Y138.713585 Z-8.000000 I-2.302322 J1.139454\n" +
        "G02 X75.448508 Y149.884912 Z-8.000000 I58.023440 J88.333225\n" +
        "G02 X67.761104 Y159.530693 Z-8.000000 I29.049042 J31.037442\n" +
        "G02 X63.337720 Y170.941692 Z-8.000000 I33.714630 J19.632055\n" +
        "G02 X61.598307 Y186.876530 Z-8.000000 I75.772043 J16.333472\n" +
        "G02 X61.962483 Y197.171263 Z-8.000000 I128.603640 J0.604451\n" +
        "G02 X63.457317 Y204.765344 Z-8.000000 I32.521667 J-2.457466\n" +
        "G02 X66.525382 Y212.422285 Z-8.000000 I57.907959 J-18.760038\n" +
        "G02 X76.244957 Y232.045349 Z-8.000000 I898.244036 J-432.694030\n" +
        "G03 X86.257462 Y248.898464 Z-8.000000 I-193.907667 J126.602136\n" +
        "G03 X90.974808 Y260.994485 Z-8.000000 I-47.015288 J25.303440\n" +
        "G03 X92.427959 Y272.279131 Z-8.000000 I-45.332559 J11.573465\n" +
        "G03 X91.806799 Y289.447012 Z-8.000000 I-202.932980 J1.252755\n" +
        "G03 X91.060853 Y317.317829 Z-8.000000 I-249.210251 J7.275429\n" +
        "G03 X89.126342 Y321.779921 Z-8.000000 I-7.558453 J-0.626526\n" +
        "G02 X86.348927 Y326.282036 Z-8.000000 I10.788872 J9.763567\n" +
        "G02 X84.489509 Y332.932993 Z-8.000000 I33.118014 J12.844254\n" +
        "G02 X84.168153 Y339.630282 Z-8.000000 I26.001621 J4.603990\n" +
        "G02 X85.561701 Y341.912026 Z-8.000000 I2.948751 J-0.234495\n" +
        "G03 X87.300914 Y345.341809 Z-8.000000 I-1.939015 J3.139119\n" +
        "G03 X85.131753 Y347.346319 Z-8.000000 I-2.169161 J-0.171413\n" +
        "G02 X81.412433 Y348.646564 Z-8.000000 I-0.000000 J5.969637\n" +
        "G02 X75.997985 Y354.235275 Z-8.000000 I18.899907 J23.727749\n" +
        "G02 X71.913401 Y361.021638 Z-8.000000 I32.068674 J23.923927\n" +
        "G02 X69.768867 Y367.939377 Z-8.000000 I23.114668 J10.956941\n" +
        "G03 X67.499375 Y376.412867 Z-8.000000 I-42.069518 J-6.726995\n" +
        "G03 X65.427531 Y379.306126 Z-8.000000 I-6.548859 J-2.501150\n" +
        "G02 X63.724760 Y382.286848 Z-8.000000 I3.121287 J3.759794\n" +
        "G02 X62.517630 Y397.332931 Z-8.000000 I93.166212 J15.046083\n" +
        "G01 X62.517630 Y412.056062 Z-8.000000\n" +
        "G01 X0.121440 Y412.056062 Z-8.000000\n" +
        "G01 X0.121440 Y15.438417 Z-8.000000\n" +
        "G00 Z-8.000000\n" +
        "\n" +
        "(End cutting path id: rect42336)\n" +
        "\n" +
        "\n" +
        "(Footer)\n" +
        "M5\n" +
        "G00 X0.0000 Y0.0000\n" +
        "M2\n" +
        "(Using default footer. To add your own footer create file \"footer\" in the output dir.)\n" +
        "(end)\n";*/
    // Split string into lines without changing your parameters
    const lines = gcode.split("\n");

    return new Promise<void>((resolve, reject) => {
        const socket = new WebSocket(espUrl);

        socket.onopen = async () => {
            console.log("‚úÖ WebSocket connected to ESP32");

            try {
                socket.send("$X");      // 1. Unlock
                await new Promise(res => setTimeout(res, 200));
                socket.send("$23=2");   // 2. Set homing direction (X+, Y-)
                await new Promise(res => setTimeout(res, 200));
                socket.send("$22=1");   // 3. Enable homing
                await new Promise(res => setTimeout(res, 200));
                socket.send("$21=1");   // 4. Enable hard limits
                await new Promise(res => setTimeout(res, 200));
                socket.send("$H");      // 5. Home the machine

                await new Promise(res => setTimeout(res, 2000));
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        console.log('üîÑ Sending line ${i + 1}: ${line}');
                        socket.send(line);
                        await new Promise(res => setTimeout(res, 200)); // 200ms delay
                    }
                }
                socket.close();
            } catch (err) {
                console.error("üö® Error while sending G-code:", err);
                socket.close();
                reject(err);
            }
        };

        socket.onclose = () => {
            console.log("üõë WebSocket closed");
            resolve();
        };

        socket.onerror = (err) => {
            console.error("‚ùå WebSocket error:", err);
            reject(err);
        };
    });
}